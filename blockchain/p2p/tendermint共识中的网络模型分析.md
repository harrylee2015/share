# tendermint共识中的网络模型分析

## tendermint网络
tendermint中共识模块网络复用了p2p网络，tendermint中的p2p网络严格上来讲，其实不算p2p，因为它本身不具备节点发现的功能，只是简单的拨号连接，只是在每次建立链接时，
会用本地节点的公私钥做一次鉴权，通过对双方随机生成的公钥信息生成的challenge进行签名，验签通过的话，双方建立安全链接通讯，通讯密钥则由本地随机生成的密钥对的私钥和远程节点传输过来的随机生成的公钥混合生成的一个sharesecret，通讯内容则是对消息体的封装，有block,tx,heat，等等类型，通过不同的goroutine进行处理。

![tendermint中通信模型]../../resource/secretcon.png)


**流程如下：**

1.节点本地各生成一个公私对，并将生成的公钥发送给对方

2.将步骤1得到的远程节点公钥和本地生成的私钥进行运算得到共享密钥shareSecret，通过本地随机生成的公钥和获取到远程节点的公钥生成sendNonce和recvNonce 两个随机值，这三个值用于后面双方安全通信的加解密

3.对步骤1生成的两个公钥，用自己本地节点初始化时的私钥去签名，生成证书，然后协同自己的本地节点初始化时的公钥发送给对方

4.远程节点对收到的证书进行验签，如果验签通过的话，双方则建立安全链接通讯

理论上讲，如果节点不本地校验远程节点的public-key是否合法的话，会存在其他伪造节点发送一个错误的信息的安全风险。节点广播消息的话，会遍历自己本地缓存的其他节点信息，（一般时validator节点,集群初始化时，从配置文件中读取）然后依次发送。

## libp2p网络

libp2p网络与tendermint网络不同，libp2p是真正意义上的p2p网络，可以做到节点的自动发现，并且新节点接入相应的网络没有限制

## tendermint共识中复用libp2p网络需要处理的问题点

 序号|问题
 ---|---
 1|原有tendermint网络，共识节点权限是由配置文件去控制，切换成使用libp2p共识节点网络权限问题，是否由配置文件中seeds去控制
 2|现有的chain33 p2p网络协议与tendermint中的有差异，tendermint中原有的对消息数据流的加减密的那一套是否需要去掉，协议需要适配
 3|chain33消息队列需要增加新的消息事件
